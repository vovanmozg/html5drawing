(()=>{function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var a=120,u=60,c={x:0,y:0,direction:0,id:null,rotate:1,program:{commands:[],current:0},options:{},xp:127,style:{h:1,s:1,b:1}},s=[[o(o({},c),{},{x:42,y:20,direction:90,id:"0.99",rotate:1,program:{commands:[1,1,0,0,1]},options:{}}),o(o({},c),{},{x:42,y:21,direction:90,id:"0.10",rotate:1,program:{commands:[0,1,1,1,0]},options:{}})],[o(o({},c),{},{x:10,y:10,direction:270,id:"0.99",rotate:1,program:{commands:[0,1]},options:{},processing:!1}),o(o({},c),{},{x:10,y:11,direction:90,id:"0.10",rotate:1,program:{commands:[0,1]},options:{},processing:!1})],[o(o({},c),{},{x:10,y:10,direction:270,id:"0.99",rotate:1,program:{commands:[5]},options:{},processing:!1})]],l=function(){function e(){t(this,e)}return n(e,null,[{key:"rand",value:function(){var t=[O.OPERATIONS.MOVE,O.OPERATIONS.ROTATE_CLOCKWISE,O.OPERATIONS.ROTATE_COUNTERCLOCKWISE,O.OPERATIONS.EAT,O.OPERATIONS.EAT_SOLAR,O.OPERATIONS.CLONE,O.OPERATIONS.OVERPOPULATION];return t[Math.floor(Math.random()*t.length)]}},{key:"execute",value:function(t,e){var n;if(!0!==t.processing){t.processing=!0;var r=(i(n={},O.OPERATIONS.MOVE,d),i(n,O.OPERATIONS.ROTATE_CLOCKWISE,f),i(n,O.OPERATIONS.ROTATE_COUNTERCLOCKWISE,h),i(n,O.OPERATIONS.EAT,m),i(n,O.OPERATIONS.EAT_SOLAR,v),i(n,O.OPERATIONS.CLONE,p),i(n,O.OPERATIONS.OVERPOPULATION,y),n);t.program.current>=t.program.commands.length&&(t.program.current=t.program.commands.length-1);var o=t.program.commands[t.program.current];void 0!==o&&(t.program.current++,t.program.current>=t.program.commands.length&&(t.program.current=0),r[o].execute(t,e),o===O.OPERATIONS.EAT_SOLAR&&y.execute(t,e))}}}]),e}(),d=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,e){var n=b.frontPosition(t),r=n.x,i=n.y,a=e.getCell(r,i);b.get(a)?t.options=o(o({},t.options),{},{hasBotInFront:!0}):(e.setCellProps(r,i,{bot:t},e.map),delete e.getCell(t.x,t.y).bot,t.x=r,t.y=i,t.options=o(o({},t.options),{},{hasBotInFront:!1}))}}]),e}(),f=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,n){t.direction=e.rotate(t.direction,1)}},{key:"rotate",value:function(t,e){return 90*(t/90+e&3)}}]),e}(),h=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,n){t.direction=e.rotate(t.direction,-1)}},{key:"rotate",value:function(t,e){return 90*(t/90+e&3)}}]),e}(),m=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,e){var n=e.getCell(t.x,t.y);n.resources.food&&(t.xp+=100,t.xp>255&&(t.xp=255),delete n.resources.food)}}]),e}(),v=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,e){var n=e.getCell(t.x,t.y);t.xp+=3*n.resources.light.power}}]),e}(),p=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,n){var r=b.backPosition(t),i=n.getCell(r.x,r.y);if(!(b.get(i)||t.xp<2*b.DEFAULT_XP)){t.xp/=2;var a=b.cloneBot(t,o(o({},r),{},{id:b.generateId(),direction:e.turn(t.direction),xp:b.DEFAULT_XP}));n.addBot(a.x,a.y,a)}}},{key:"turn",value:function(t){return 90*(t/90+2&3)}}]),e}(),y=function(){function e(){t(this,e)}return n(e,null,[{key:"execute",value:function(t,e){var n=0;e.eachNeighborBot(t,e,(function(t){n++})),console.log(n),t.xp-=n/3}}]),e}(),g=function(){function e(){t(this,e)}return n(e,null,[{key:"mutate",value:function(t){var n=this;if(!(Math.random()>e.MUTATION_PROBABILITY)){var r=[function(t,e){return n.mutateSubstitution(t,e)},function(t,e){return n.mutateDeletion(t,e)},function(t,e){return n.mutateInsertion(t,e)}],o=Math.floor(Math.random()*t.program.commands.length);r.random()(t.program.commands,o),t.style.h=this.randomChangeStyleComponent(t.style.h),t.style.s=this.randomChangeStyleComponent(t.style.s),t.style.v=this.randomChangeStyleComponent(t.style.v)}}},{key:"randomChangeStyleComponent",value:function(t){var e=.01,n=Math.random()>.5?1:-1;return(t+e*n<=0||t+e*n>=1)&&(n*=-1),t+e*n}},{key:"mutateSubstitution",value:function(t,e){return t[e]=this.randomOperationCode(),t}},{key:"mutateDeletion",value:function(t,e){return t.splice(e,1),t}},{key:"mutateInsertion",value:function(t,e){return t.splice(e,0,this.randomOperationCode()),t}},{key:"randomOperationsPosition",value:function(t){return Math.floor(Math.random()*bot.program.commands.length)}},{key:"randomOperationCode",value:function(){return Object.values(O.OPERATIONS).random()}}]),e}();i(g,"MUTATION_PROBABILITY",.001);var O=function(){function e(){t(this,e)}return n(e,null,[{key:"generate",value:function(){for(var t=[],e=0;e<10;e++)t.push(l.rand());return{commands:t,current:0}}},{key:"step",value:function(t,e){l.execute(t,e)}}]),e}();i(O,"OPERATIONS",{MOVE:0,ROTATE_CLOCKWISE:1,ROTATE_COUNTERCLOCKWISE:2,EAT:3,EAT_SOLAR:4,CLONE:5,OVERPOPULATION:6});var b=function(){function e(){t(this,e)}return n(e,null,[{key:"generateRandom",value:function(t,n){return o(o({},c),{},{id:e.generateId(),x:t,y:n,direction:90*Math.floor(4*Math.random()),rotate:Math.random()>.5?1:-1,program:O.generate(),options:{},style:{h:Math.random(),s:Math.random(),v:Math.random()}})}},{key:"get",value:function(t){return t.bot}},{key:"frontPosition",value:function(t){var e=[[1,0],[0,-1],[-1,0],[0,1]][t.direction/90];return C.normalizeCoords(t.x+e[0],t.y+e[1])}},{key:"backPosition",value:function(t){var e=[[-1,0],[0,1],[1,0],[0,-1]][t.direction/90];return C.normalizeCoords(t.x+e[0],t.y+e[1])}},{key:"cloneBot",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=JSON.parse(JSON.stringify(t));return o(o({},n),e)}},{key:"generateId",value:function(){return""+Math.random()}},{key:"liveStep",value:function(t){t.xp--}},{key:"tryDie",value:function(t,e){if(t.xp<=0){e.destroyBot(t);var n=k.generateRandom();k.add(t.x,t.y,n,e.map)}}},{key:"isProcessing",value:function(t){return 0==t.processing}}]),e}();i(b,"DEFAULT_XP",10);var k=function(){function e(){t(this,e)}return n(e,null,[{key:"add",value:function(t,e,n,r){C.validateCoords(t,e),r[t][e].resources=o(o({},r[t][e].resources),n)}},{key:"generateRandom",value:function(){return{food:{type:"food"}}}}]),e}(),C=function(){function e(n,r){t(this,e),this.width=n,this.height=r,this.initCells(),window.debugWorld=this}return n(e,[{key:"eachCell",value:function(t){for(var e=0;e<this.width;e++)for(var n=0;n<this.height;n++)t(e,n)}},{key:"eachBot",value:function(t){var e=this;this.eachCell((function(n,r){var o=b.get(e.getCell(n,r));o&&t(o)}))}},{key:"eachNeighborBot",value:function(t,n,r){for(var o=-1;o<=1;o++)for(var i=-1;i<=1;i++)if(0!==o&&0!==i){var a=e.normalizeCoords(t.x+o,t.y+i),u=n.getCell(a.x,a.y),c=b.get(u);c&&b.isProcessing(c)&&r(c)}}},{key:"populate",value:function(){var t=this;this.eachCell((function(e,n){Math.random()>.9&&t.addBot(e,n,b.generateRandom(e,n))}))}},{key:"populateTest1",value:function(){var t=this;s[2].forEach((function(e){t.addBot(e.x,e.y,e)}))}},{key:"initResources",value:function(t){this.eachCell((function(e,n){if(Math.random()>.9){var r=k.generateRandom();k.add(e,n,r,t)}var o={light:{type:"light",power:1-n/u}};k.add(e,n,o,t)}))}},{key:"step",value:function(){var t=this;this.eachBot((function(e){g.mutate(e),O.step(e,t),b.liveStep(e),b.tryDie(e,t)})),this.eachBot((function(t){return t.processing=!1}))}},{key:"destroyBot",value:function(t){delete this.getCell(t.x,t.y).bot}},{key:"getCell",value:function(t,e){return this.map[t][e]}},{key:"setCellProps",value:function(t,e,n,r){r[t][e]=o(o({},r[t][e]),n)}},{key:"initCell",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;void 0===n&&(n={resources:{}}),void 0===this.map[t]&&(this.map[t]=[]),this.map[t][e]=n}},{key:"initCells",value:function(){var t=this;this.map=[],this.eachCell((function(e,n){t.initCell(e,n)}))}},{key:"addBot",value:function(t,n,r){if(e.validateCoords(t,n),this.map[t][n].bot)throw"Bot already exists in cell ".concat(t,":").concat(n);this.map[t][n].bot=r}},{key:"print",value:function(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++)this.map[e][t].bot}}],[{key:"validateCoords",value:function(t,e){if(t>=a||t<0)throw"x should be from 0 to ".concat(a);if(e>=u||e<0)throw"x should be from 0 to ".concat(a)}},{key:"normalizeCoords",value:function(t,e){return t<0&&(t=119),t>119&&(t=0),e<0&&(e=59),e>59&&(e=0),{x:t,y:e}}}]),e}(),x=function(){function e(){t(this,e)}return n(e,null,[{key:"create",value:function(){var t=new C(a,u);return t.populate(),t.initResources(t.map),t}}]),e}(),E=function(){function e(n){t(this,e),this.world=n,this.size=10;var r=document.getElementById("cnv");r.width=a*this.size,r.height=u*this.size,this.ctx=r.getContext("2d")}return n(e,[{key:"redraw",value:function(){for(var t=this,e=this.ctx.createImageData(a*this.size,u*this.size),n=0;n<a*this.size*u*this.size*4;n+=4)e.data[n]=0,e.data[n+1]=0,e.data[n+2]=0,e.data[n+3]=255;this.world.eachCell((function(n,r){var o=t.world.getCell(n,r);o.resources&&(o.resources.food,t.drawResource(n,r,o.resources,e))})),this.world.eachBot((function(n){t.drawBot(n,e)})),this.ctx.putImageData(e,0,0)}},{key:"drawResource",value:function(t,e,n,r){n.food&&(t*=this.size,e*=this.size,this.writeImageDataResource(t,e,{r:140,g:80,b:0},r))}},{key:"writeImageDataResource",value:function(t,e,n,r){for(var o=t+2;o<t+this.size-2;o++)for(var i=e+2;i<e+this.size-2;i++)this.writeImageDataPixel(o,i,n,r)}},{key:"drawBot",value:function(t,e){var n;n=function(t,e,n){var r,o,i,a,u,c,s,l;switch(1===arguments.length&&(e=t.s,n=t.v,t=t.h),c=n*(1-e),s=n*(1-(u=6*t-(a=Math.floor(6*t)))*e),l=n*(1-(1-u)*e),a%6){case 0:r=n,o=l,i=c;break;case 1:r=s,o=n,i=c;break;case 2:r=c,o=n,i=l;break;case 3:r=c,o=s,i=n;break;case 4:r=l,o=c,i=n;break;case 5:r=n,o=c,i=s}return{r:Math.round(255*r),g:Math.round(255*o),b:Math.round(255*i)}}(t.style.h,t.style.s,t.style.v);var r=(t=this.setColor(t)).x*this.size,o=t.y*this.size;this.writeImageDataBot(r,o,t.direction,n,e)}},{key:"setColor",value:function(t){return t}},{key:"writeImageDataBot",value:function(t,e,n,r,o){for(var i=t;i<t+this.size;i++)for(var a=e;a<e+this.size;a++)this.writeImageDataPixel(i,a,r,o)}},{key:"writeImageDataPixel",value:function(t,e,n,r){var o=e*(a*this.size*4)+4*t+0;r.data[o]=n.r,o++,r.data[o]=n.g,o++,r.data[o]=n.b,o++,r.data[o]=255}}]),e}(),w=0,I=function(){function e(n){if(t(this,e),!n)throw Error("Invalid argument world");this.world=n,this.drawer=new E(n)}return n(e,[{key:"step",value:function(){var t=this,e=performance.now();this.world.step(),e=performance.now()-e,w++;var n=performance.now();this.drawer.redraw(),n=performance.now()-n,w%11==0&&console.log("perf: ".concat(e,", ").concat(n," milliseconds.")),requestAnimationFrame((function(){return t.step()}))}},{key:"run",value:function(){var t=this;requestAnimationFrame((function(){return t.step()})),this.initDebugWindow()}},{key:"initDebugWindow",value:function(){var t=this,e=document.getElementById("cnv");document.getElementById("info"),e.addEventListener("mousedown",(function(n){var r=e.clientWidth/a,o=e.clientHeight/u,i=parseInt(n.x/r),c=parseInt(n.y/o);t.debugOptions={botX:i,botY:c}})),requestAnimationFrame((function(){return t.updateDebugWindow()}))}},{key:"updateDebugWindow",value:function(){var t=this;if(this.debugOptions){var e=document.getElementById("info"),n=debugWorld.getCell(this.debugOptions.botX,this.debugOptions.botY),r=b.get(n);r||(r={x:"",y:"",xp:"",program:"",id:""});var o="";o+="x: ".concat(r.x,"</br>"),o+="y: ".concat(r.y,"</br>"),o+="xp: ".concat(Math.floor(r.xp),"</br>"),o+="program: ".concat(r.program.commands,"</br>"),o+="id: ".concat(r.id,"</br>"),e.innerHTML=o}requestAnimationFrame((function(){return t.updateDebugWindow()}))}}]),e}();Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},new I(x.create()).run()})();